<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>TwoT AI - Futures Pro Scanner</title>
    <style>
        :root { --bg: #0b0e11; --card: #161b22; --accent: #2962ff; --text: #e2e8f0; --green: #0ecb81; --red: #f6465d; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 240px; background: #0f1319; border-right: 1px solid #2d3436; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .brand { font-size: 1.4rem; font-weight: 900; color: var(--text); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--accent); }
        .nav-btn { padding: 12px; border-radius: 4px; border: none; background: transparent; color: #848e9c; text-align: left; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .nav-btn:hover, .nav-btn.active { background: rgba(41, 98, 255, 0.1); color: var(--accent); }

        /* MAIN */
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .controls-bar { display: flex; gap: 10px; background: var(--card); padding: 10px; border-radius: 8px; border: 1px solid #2d3436; }
        select, button { padding: 8px 15px; border-radius: 4px; border: 1px solid #474d57; background: #2b3139; color: white; font-weight: 600; cursor: pointer; }
        .btn-scan { background: var(--accent); border: none; }
        .btn-scan:hover { filter: brightness(1.1); }

        /* GRID */
        .scanner-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }

        /* SIGNAL CARD */
        .card { background: var(--card); border-radius: 8px; padding: 15px; border: 1px solid #2d3436; position: relative; transition: 0.2s; }
        .card:hover { border-color: var(--accent); transform: translateY(-2px); }
        
        .card-head { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .coin-name { font-weight: 900; font-size: 1.1rem; }
        .strat-tag { font-size: 0.75rem; padding: 2px 6px; border-radius: 3px; background: #2b3139; color: #848e9c; }

        .big-price { font-size: 1.4rem; font-weight: bold; margin: 10px 0; }
        .green-text { color: var(--green); }
        .red-text { color: var(--red); }

        .target-box { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 0.9rem; }
        .target-row { display: flex; justify-content: space-between; margin-bottom: 5px; }

        /* SCHEMATIC DIAGRAM (SVG) */
        .diagram-container { margin-top: 15px; height: 60px; width: 100%; position: relative; opacity: 0.8; }
        .diagram-svg { width: 100%; height: 100%; overflow: visible; }
        .path-line { fill: none; stroke-width: 2; stroke-dasharray: 4; }
        .arrow-head { fill: currentColor; }

        .loading { text-align: center; color: #848e9c; padding: 20px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand">TwoT <span>FUTURES</span></div>
    <button class="nav-btn active" onclick="ui.showPage('scanner')">‚ö° Strategy Scanner</button>
    <button class="nav-btn" onclick="ui.showPage('missed')">üï∞ Missed Trades</button>
    <button class="nav-btn" onclick="ui.showPage('history')">üìú My History</button>
    <div style="margin-top:auto; font-size:0.7rem; color:#474d57;">System: <span style="color:var(--green)">‚óè Online</span></div>
</div>

<div class="main">
    <div id="page-scanner">
        <div class="header">
            <h2>Live Market Opportunities</h2>
        </div>
        
        <div class="controls-bar">
            <select id="modeSelect" onchange="app.toggleMode()">
                <option value="auto">Auto (Top 10 Coins)</option>
                <option value="manual">Manual Selection</option>
            </select>
            <select id="manualSymbol" style="display:none;">
                <option value="BTCUSDT">BTC/USDT</option>
                <option value="ETHUSDT">ETH/USDT</option>
                <option value="SOLUSDT">SOL/USDT</option>
            </select>
            <button onclick="app.runScan()" class="btn-scan">üîç SCAN NOW</button>
        </div>

        <div id="scanResults" class="scanner-grid" style="margin-top:20px;"></div>
    </div>

    <div id="page-missed" style="display:none;">
        <h2>Missed Opportunities (24h)</h2>
        <div id="missedList"></div>
    </div>
</div>

<script>
    const CONFIG = {
        coins: ['BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'SOLUSDT', 'XRPUSDT', 'ADAUSDT', 'DOGEUSDT', 'AVAXUSDT'],
        timeframes: ['15m', '1h', '4h']
    };

    class FuturesEngine {
        constructor() {
            this.scanning = false;
        }

        async runScan() {
            if(this.scanning) return;
            this.scanning = true;
            ui.showLoading();

            const mode = document.getElementById('modeSelect').value;
            const symbols = mode === 'auto' ? CONFIG.coins : [document.getElementById('manualSymbol').value];
            const results = [];

            // Parallel Scan
            const promises = [];
            symbols.forEach(sym => {
                CONFIG.timeframes.forEach(tf => {
                    promises.push(this.analyze(sym, tf).then(res => { if(res) results.push(res); }));
                });
            });

            await Promise.all(promises);
            ui.renderResults(results);
            this.scanning = false;
        }

        async analyze(symbol, timeframe) {
            try {
                const res = await fetch(`/proxy/klines?symbol=${symbol}&interval=${timeframe}&limit=200`);
                const data = await res.json();
                const klines = this.formatKlines(data);
                const indicators = this.calculateIndicators(klines);
                
                // CHECK ALL STRATEGIES
                let signal = null;

                // 1. Bollinger Squeeze Breakout (Volatility)
                signal = signal || this.strat_Bollinger(klines, indicators);
                // 2. MACD Momentum (Trend)
                signal = signal || this.strat_MACD(klines, indicators);
                // 3. SMC Sweep (Reversal)
                signal = signal || this.strat_SMC(klines);
                // 4. Double Top/Bottom (Pattern)
                signal = signal || this.strat_Patterns(klines);

                if(signal) {
                    return {
                        symbol, timeframe, ...signal,
                        currentPrice: klines[klines.length-1].close
                    };
                }
            } catch(e) { return null; }
        }

        // --- STRATEGY MODULES ---

        strat_Bollinger(data, ind) {
            const c = data[data.length-1].close;
            // Breakout logic
            if (c > ind.bb.upper && ind.width > 0.05) return { name: 'Bollinger Breakout', type: 'LONG', target: c + (ind.atr*3), sl: ind.bb.middle };
            if (c < ind.bb.lower && ind.width > 0.05) return { name: 'Bollinger Breakdown', type: 'SHORT', target: c - (ind.atr*3), sl: ind.bb.middle };
            return null;
        }

        strat_MACD(data, ind) {
            const c = data[data.length-1].close;
            // Histogram Flip
            if (ind.macd.hist > 0 && ind.macd.prevHist < 0) return { name: 'MACD Momentum', type: 'LONG', target: c + (ind.atr*2), sl: c - ind.atr };
            if (ind.macd.hist < 0 && ind.macd.prevHist > 0) return { name: 'MACD Momentum', type: 'SHORT', target: c - (ind.atr*2), sl: c + ind.atr };
            return null;
        }

        strat_SMC(data) {
            const i = data.length - 1;
            const c = data[i].close;
            const l = data[i].low;
            const prevL = data[i-1].low;
            // Bullish Sweep
            if (l < prevL && c > prevL) return { name: 'Liquidity Sweep', type: 'LONG', target: c*1.02, sl: l };
            return null;
        }

        strat_Patterns(data) {
            // Simple Pivot check for Double Top/Bottom would go here
            return null; 
        }

        // --- MATH ---
        calculateIndicators(d) {
            const closes = d.map(k=>k.close);
            const bb = this.bb(closes);
            const atr = this.atr(d);
            const macd = this.macd(closes);
            return { bb, atr, macd, width: (bb.upper-bb.lower)/bb.middle };
        }

        bb(data) {
            const slice = data.slice(-20);
            const avg = slice.reduce((a,b)=>a+b,0)/20;
            const std = Math.sqrt(slice.reduce((a,b)=>a+Math.pow(b-avg,2),0)/20);
            return { upper: avg+2*std, lower: avg-2*std, middle: avg };
        }

        atr(d) {
            let tr = 0;
            for(let i=1; i<d.length; i++) tr += Math.max(d[i].high-d[i].low, Math.abs(d[i].high-d[i-1].close), Math.abs(d[i].low-d[i-1].close));
            return tr / d.length;
        }

        macd(data) {
            // Simplified Momentum logic
            const short = data.slice(-12).reduce((a,b)=>a+b,0)/12;
            const long = data.slice(-26).reduce((a,b)=>a+b,0)/26;
            return { hist: short-long, prevHist: (data[data.length-2]-data[data.length-3]) }; // Dummy prev for logic
        }

        formatKlines(d) { return d.map(k => ({ high: parseFloat(k[2]), low: parseFloat(k[3]), close: parseFloat(k[4]) })); }
    }

    // ========================
    // UI RENDERER (The Graphics)
    // ========================
    const ui = {
        showLoading: () => document.getElementById('scanResults').innerHTML = '<div class="loading">Scanning 10 Markets & 3 Timeframes...</div>',
        
        renderResults: (list) => {
            const div = document.getElementById('scanResults');
            if(list.length === 0) { div.innerHTML = '<div class="loading">No strong setups found. Market is choppy.</div>'; return; }
            
            div.innerHTML = list.map(item => {
                const isLong = item.type === 'LONG';
                const color = isLong ? 'var(--green)' : 'var(--red)';
                const arrow = isLong ? '‚Üë' : '‚Üì';
                
                // SVG SCHEMATIC
                const svg = isLong 
                    ? `<path d="M10,40 L40,20 L60,35 L90,5" class="path-line" stroke="${color}"/><circle cx="40" cy="20" r="3" fill="${color}"/><text x="90" y="15" fill="${color}" font-size="10">TP</text>`
                    : `<path d="M10,10 L40,30 L60,15 L90,45" class="path-line" stroke="${color}"/><circle cx="40" cy="30" r="3" fill="${color}"/><text x="90" y="40" fill="${color}" font-size="10">TP</text>`;

                return `
                <div class="card">
                    <div class="card-head">
                        <span class="coin-name">${item.symbol} <span style="font-weight:400; font-size:0.8rem; color:#848e9c;">${item.timeframe}</span></span>
                        <span class="strat-tag">${item.name}</span>
                    </div>
                    <div class="big-price ${isLong?'green-text':'red-text'}">
                        ${arrow} GOING ${isLong?'UP':'DOWN'}
                    </div>
                    <div class="target-box">
                        <div class="target-row"><span>Current:</span> <strong>$${item.currentPrice.toFixed(2)}</strong></div>
                        <div class="target-row"><span>Target:</span> <strong style="color:${color}">$${item.target.toFixed(2)}</strong></div>
                        <div class="target-row"><span>Stop:</span> <strong style="color:#848e9c">$${item.sl.toFixed(2)}</strong></div>
                    </div>
                    <div class="diagram-container">
                        <svg class="diagram-svg" viewBox="0 0 100 50">${svg}</svg>
                    </div>
                </div>
                `;
            }).join('');
        },

        showPage: (p) => {
            document.getElementById('page-scanner').style.display = p==='scanner'?'block':'none';
            document.getElementById('page-missed').style.display = p==='missed'?'block':'none';
            if(p==='missed') app.scanMissed(); // Trigger missed scan
        }
    };

    const app = new FuturesEngine();
    app.toggleMode = () => {
        const m = document.getElementById('modeSelect').value;
        document.getElementById('manualSymbol').style.display = m==='manual'?'inline-block':'none';
    }
</script>
</body>
</html>
