





<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>TwoT AI - Restored SMC Engine</title>
    <style>
        /* --- DARK THEME --- */
        :root { --bg: #0f172a; --card: #1e293b; --primary: #3b82f6; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --text: #f8fafc; --muted: #94a3b8; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding-bottom: 80px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        
        header { background: rgba(30, 41, 59, 0.95); padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        h1 { background: linear-gradient(90deg, var(--primary), var(--success)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }

        .controls { display: flex; gap: 10px; flex-wrap: wrap; }
        select, button { padding: 10px 15px; border-radius: 8px; border: 1px solid #475569; background: var(--card); color: white; font-weight: 600; cursor: pointer; }
        .btn-primary { background: var(--primary); border: none; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-stop { background: var(--danger); border: none; display: none; }
        .btn-clear { background: #475569; border: none; font-size: 0.8rem; }

        .tabs { display: flex; gap: 20px; margin: 20px 0; border-bottom: 1px solid #334155; }
        .tab { padding: 10px 0; cursor: pointer; color: var(--muted); position: relative; }
        .tab.active { color: var(--primary); font-weight: bold; }
        .tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }

        /* LIVE MONITOR */
        .monitor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 10px; }
        .monitor-box { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center; }
        .monitor-label { font-size: 0.8rem; color: var(--muted); }
        .monitor-val { font-size: 1.2rem; font-weight: bold; display: block; margin-top: 5px; }

        /* ORDER BOOK */
        .ob-container { margin-top: 20px; }
        .ob-bar { height: 10px; width: 100%; background: #334155; border-radius: 5px; overflow: hidden; display: flex; margin-top: 5px; }
        .ob-bids { background: var(--success); height: 100%; transition: width 0.5s ease; }
        .ob-asks { background: var(--danger); height: 100%; transition: width 0.5s ease; }
        .ob-text { display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 5px; font-weight: bold; }

        /* SESSION FEED */
        .session-feed { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .prediction-card { background: #151e2e; padding: 15px; border-radius: 8px; border-left: 5px solid #475569; animation: slideIn 0.5s ease; position: relative; }
        .prediction-card.BUY { border-left-color: var(--success); background: rgba(16, 185, 129, 0.05); }
        .prediction-card.SELL { border-left-color: var(--danger); background: rgba(239, 68, 68, 0.05); }
        .prediction-card.HOLD { border-left-color: var(--warning); }
        .prediction-card.SKIP { border-left-color: #475569; opacity: 0.7; }

        .pred-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .pred-type { font-weight: 900; font-size: 1.1rem; }
        
        .risk-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 0.9rem; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; }

        .feedback-area { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .btn-mini { flex: 1; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; opacity: 0.9; font-size: 0.8rem; }
        .btn-mini:hover { opacity: 1; }
        
        .btn-win { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .btn-loss { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .btn-missed-buy { background: rgba(59, 130, 246, 0.2); color: var(--primary); }
        .btn-missed-sell { background: rgba(59, 130, 246, 0.2); color: var(--primary); }
        .btn-good-hold { background: rgba(245, 158, 11, 0.2); color: var(--warning); }

        .countdown { font-family: monospace; font-size: 1.5rem; color: var(--primary); text-align: center; margin-bottom: 10px; }

        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <h1>TwoT AI <span style="font-size:0.8rem; color:var(--primary);">Restored Logic</span></h1>
                <div class="controls">
                    <select id="symbolSelect">
                        <option value="BTCUSDT">BTC/USDT</option>
                        <option value="ETHUSDT">ETH/USDT</option>
                        <option value="SOLUSDT">SOL/USDT</option>
                        <option value="XRPUSDT">XRP/USDT</option>
                        <option value="BNBUSDT">BNB/USDT</option>
                    </select>
                    <select id="timeframeSelect">
                        <option value="1m">1 Minute</option>
                        <option value="5m">5 Minutes</option>
                        <option value="15m">15 Minutes</option>
                        <option value="1h" selected>1 Hour</option>
                        <option value="4h">4 Hours</option>
                        <option value="1d">1 Day</option>
                    </select>
                    <button id="startBtn" class="btn-primary">▶ Start Session</button>
                    <button id="stopBtn" class="btn-stop">⏹ Stop</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="dashboard">Live Session</div>
            <div class="tab" data-tab="learning">AI Learning</div>
            <div class="tab" data-tab="history">History</div>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboardTab" class="tab-content active">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Live Market Monitor</h3>
                    <div style="text-align:right;">
                        <span id="connectionStatus" style="font-size:0.8rem; color:var(--muted);">Syncing Time...</span>
                        <div id="countdown" class="countdown">--:--</div>
                    </div>
                </div>
                
                <div class="monitor-grid">
                    <div class="monitor-box">
                        <span class="monitor-label">Price</span>
                        <span id="livePrice" class="monitor-val">---</span>
                    </div>
                    <div class="monitor-box">
                        <span class="monitor-label">Strategy: SMC</span>
                        <span id="btcTrend" class="monitor-val">---</span>
                    </div>
                    <div class="monitor-box">
                        <span class="monitor-label">Order Book Bias</span>
                        <span id="obStatus" class="monitor-val">Scanning</span>
                    </div>
                </div>

                <div class="ob-container">
                    <div class="ob-text">
                        <span id="bidPct" style="color:var(--success)">--% Buyers</span>
                        <span id="askPct" style="color:var(--danger)">--% Sellers</span>
                    </div>
                    <div class="ob-bar">
                        <div id="obBids" class="ob-bids" style="width: 50%"></div>
                        <div id="obAsks" class="ob-asks" style="width: 50%"></div>
                    </div>
                    <div style="text-align:center; font-size:0.7rem; color:var(--muted); margin-top:5px;">
                        Real-Time Order Book (Authority Restored)
                    </div>
                </div>
            </div>

            <div id="sessionArea" style="display:none;">
                <div class="card" style="border-left: 4px solid var(--primary);">
                    <h3>Prediction Feed</h3>
                    <p style="color:var(--muted); font-size:0.9rem;">
                        Analyzing Closed Candles + Order Book + SMC Wicks.
                    </p>
                </div>
                <div id="predictionFeed" class="session-feed"></div>
            </div>
        </div>

        <!-- LEARNING -->
        <div id="learningTab" class="tab-content">
            <div class="card">
                <h3>AI Adaptation</h3>
                <div id="blacklistContainer" style="margin-top:15px;"></div>
            </div>
            <div class="card">
                <h3>Performance</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; text-align:center;">
                    <div>Wins: <strong id="totalWins" style="color:var(--success)">0</strong></div>
                    <div>Losses: <strong id="totalLosses" style="color:var(--danger)">0</strong></div>
                    <div>Acc: <strong id="accuracy">0%</strong></div>
                </div>
            </div>
        </div>

        <!-- HISTORY -->
        <div id="historyTab" class="tab-content">
            <div class="card">
                <div style="display:flex; justify-content:space-between;">
                    <h3>Signal History</h3>
                    <button onclick="app.clearHistory()" class="btn-clear">Clear All</button>
                </div>
                <div id="historyList" style="margin-top:15px; display:flex; flex-direction:column; gap:10px;"></div>
            </div>
        </div>
    </div>

    <script>
        class TwoTRestored {
            constructor() {
                this.symbol = 'BTCUSDT';
                this.timeframe = '1m';
                this.isSessionActive = false;
                this.processing = false;
                this.timeOffset = 0; 
                
                this.history = JSON.parse(localStorage.getItem('twot_history')) || [];
                this.stats = JSON.parse(localStorage.getItem('twot_stats')) || { wins: 0, losses: 0 };
                this.blacklist = JSON.parse(localStorage.getItem('twot_blacklist')) || [];
                
                this.init();
            }

            async init() {
                this.setupUI();
                this.renderStats();
                this.renderBlacklist();
                this.renderHistory();
                await this.syncTime();
                this.startLiveMonitor();
            }

            // ============ 1. TIME SYNC ============
            async syncTime() {
                try {
                    const start = Date.now();
                    const res = await fetch('https://api.binance.com/api/v3/time');
                    const data = await res.json();
                    const end = Date.now();
                    this.timeOffset = (data.serverTime - end) + ((end - start) / 2);
                    console.log('Time Offset:', this.timeOffset);
                } catch (e) { console.log('Local Time'); }
            }

            getCorrectTime() { return Date.now() + this.timeOffset; }

            // ============ 2. LIVE MONITOR ============
            startLiveMonitor() {
                this.updateMonitor();
                setInterval(() => this.updateMonitor(), 2000);
                setInterval(() => this.updateCountdown(), 1000);
            }

            async updateMonitor() {
                try {
                    const [tickRes, depthRes] = await Promise.all([
                        fetch(`/proxy/ticker?symbol=${this.symbol}`),
                        fetch(`/proxy/depth?symbol=${this.symbol}&limit=50`)
                    ]);
                    const ticker = await tickRes.json();
                    const depth = await depthRes.json();

                    document.getElementById('livePrice').innerText = parseFloat(ticker.price).toFixed(2);
                    document.getElementById('connectionStatus').innerText = 'Live (Synced) ⚡';
                    document.getElementById('connectionStatus').style.color = '#10b981';

                    const bids = depth.bids.reduce((a, b) => a + parseFloat(b[1]), 0);
                    const asks = depth.asks.reduce((a, b) => a + parseFloat(b[1]), 0);
                    const total = bids + asks;
                    const bidPct = (bids / total) * 100;

                    document.getElementById('obBids').style.width = `${bidPct}%`;
                    document.getElementById('obAsks').style.width = `${100 - bidPct}%`;
                    document.getElementById('bidPct').innerText = `${bidPct.toFixed(0)}% Buys`;
                    document.getElementById('askPct').innerText = `${(100 - bidPct).toFixed(0)}% Sells`;
                    
                    const obStatus = bidPct > 55 ? "Bids > Asks" : bidPct < 45 ? "Asks > Bids" : "Neutral";
                    document.getElementById('obStatus').innerText = obStatus;

                } catch (e) { document.getElementById('connectionStatus').innerText = 'Reconnecting...'; }
            }

            updateCountdown() {
                const now = this.getCorrectTime();
                const map = {'1m':60000, '5m':300000, '15m':900000, '1h':3600000, '4h':14400000, '1d':86400000};
                const intervalMs = map[this.timeframe] || 3600000;
                
                const timeToNext = intervalMs - (now % intervalMs);
                const seconds = Math.floor((timeToNext / 1000) % 60);
                const minutes = Math.floor((timeToNext / 1000 / 60));
                document.getElementById('countdown').innerText = `${minutes}:${seconds < 10 ? '0'+seconds : seconds}`;

                // TRIGGER 1s AFTER OPEN
                const timePassed = intervalMs - timeToNext;
                if (this.isSessionActive && timePassed > 1000 && timePassed < 3000) {
                    if (!this.processing) {
                        this.processing = true;
                        const currentCandleTime = now - timePassed; 
                        this.generateSignal(currentCandleTime);
                        setTimeout(() => this.processing = false, 5000); 
                    }
                }
            }

            toggleSession() {
                this.isSessionActive = !this.isSessionActive;
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');
                const area = document.getElementById('sessionArea');
                
                if(this.isSessionActive) {
                    startBtn.style.display = 'none'; stopBtn.style.display = 'inline-block'; area.style.display = 'flex';
                    const now = this.getCorrectTime();
                    const map = {'1m':60000, '5m':300000, '15m':900000, '1h':3600000, '4h':14400000, '1d':86400000};
                    const intervalMs = map[this.timeframe] || 3600000;
                    const currentCandleStart = now - (now % intervalMs);
                    this.generateSignal(currentCandleStart);
                } else {
                    startBtn.style.display = 'inline-block'; stopBtn.style.display = 'none';
                }
            }

            // ============ 3. LOGIC ENGINE (RESTORED SMC + OB) ============
            async generateSignal(targetTimeMs) {
                const feed = document.getElementById('predictionFeed');
                const loadId = 'loading-' + Date.now();
                if(document.getElementById('predictionFeed').childElementCount > 50) document.getElementById('predictionFeed').lastChild.remove();
                
                const dateObj = new Date(targetTimeMs);
                const targetTimeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                feed.insertAdjacentHTML('afterbegin', `<div id="${loadId}" class="prediction-card"><span class="blink">Logic: SMC + OB + Reversion...</span></div>`);

                try {
                    const res = await fetch(`/proxy/klines?symbol=${this.symbol}&interval=${this.timeframe}&limit=100`);
                    const data = await res.json();
                    const klines = this.formatKlines(data);
                    const finishedKlines = klines.slice(0, -1); // Use closed data
                    
                    // BTC FILTER
                    let btcTrend = 'NEUTRAL';
                    if (this.symbol !== 'BTCUSDT') {
                        try {
                            const bRes = await fetch(`/proxy/klines?symbol=BTCUSDT&interval=${this.timeframe}&limit=50`);
                            const bData = await bRes.json();
                            const bKlines = this.formatKlines(bData).slice(0, -1);
                            const bSma = this.calculateSMA(bKlines, 20);
                            btcTrend = bKlines[bKlines.length-1].close > bSma ? 'BULLISH' : 'BEARISH';
                        } catch(e) {}
                    }
                    document.getElementById('btcTrend').innerText = btcTrend;
                    document.getElementById('btcTrend').style.color = btcTrend === 'BULLISH' ? 'var(--success)' : 'var(--danger)';

                    // CALCULATIONS
                    const rsi = this.calculateRSI(finishedKlines);
                    const bb = this.calculateBollinger(finishedKlines);
                    const atr = this.calculateATR(finishedKlines);
                    const closePrice = finishedKlines[finishedKlines.length-1].close;
                    
                    // 1. RESTORED: SMC Sweep Detection
                    const sweep = this.detectSweep(finishedKlines); // "Bullish Sweep" or "Bearish Sweep"

                    // 2. RESTORED: Order Book Width
                    const bidWidth = parseFloat(document.getElementById('obBids').style.width) || 50;

                    // SNAPSHOT (Learning)
                    const snapshot = {
                        btcTrend,
                        rsiState: rsi > 70 ? 'Over' : rsi < 30 ? 'Under' : 'Mid',
                        obState: bidWidth > 55 ? 'BuyHeavy' : bidWidth < 45 ? 'SellHeavy' : 'Balanced'
                    };

                    // PENALTY
                    let penalty = 0;
                    const isMistake = this.blacklist.some(b => b.btcTrend === snapshot.btcTrend && b.rsiState === snapshot.rsiState);
                    if(isMistake) penalty = 0.2; 

                    // *** RESTORED SCORING SYSTEM (PHASE 3 LOGIC) ***
                    let score = 0;
                    let reasons = [];

                    // A. Order Book (Significant Weight Restored)
                    if(bidWidth > 55) { score += 0.25; reasons.push("Order Book: Buyers Dominating"); }
                    else if(bidWidth < 45) { score -= 0.25; reasons.push("Order Book: Sellers Dominating"); }

                    // B. SMC Sweeps (High Probability)
                    if(sweep === 'Bullish Sweep') { score += 0.4; reasons.push("SMC: Bullish Liquidity Sweep"); }
                    if(sweep === 'Bearish Sweep') { score -= 0.4; reasons.push("SMC: Bearish Liquidity Sweep"); }

                    // C. Bollinger Reversion (The 70% Accuracy Logic)
                    if(closePrice < bb.lower) { score += 0.3; reasons.push("Price Outside Lower BB (Oversold)"); }
                    if(closePrice > bb.upper) { score -= 0.3; reasons.push("Price Outside Upper BB (Overbought)"); }

                    // D. RSI (Reversion Logic Restored)
                    // RSI < 30 is GOOD for Buy. RSI > 70 is GOOD for Sell.
                    if(rsi < 30) { score += 0.2; reasons.push("RSI Oversold (<30)"); }
                    if(rsi > 70) { score -= 0.2; reasons.push("RSI Overbought (>70)"); }

                    // E. BTC Alignment
                    if(btcTrend === 'BULLISH') score += 0.1;
                    if(btcTrend === 'BEARISH') score -= 0.1;

                    if(penalty > 0) {
                        if(score > 0) score -= penalty; else score += penalty;
                        reasons.push(`⚠ Learning Penalty Applied`);
                    }

                    // DECISION
                    let signal = 'HOLD';
                    let type = 'HOLD';

                    // Logic: We need Score > 0.3 to trade (Confluence)
                    if(score >= 0.3) { signal = 'BUY'; type = 'BUY'; }
                    else if(score <= -0.3) { signal = 'SELL'; type = 'SELL'; }

                    // RISK
                    let stopLoss = 0, takeProfit = 0;
                    if(signal === 'BUY') {
                        stopLoss = closePrice - (atr * 1.5);
                        takeProfit = closePrice + (atr * 2.5);
                    } else if(signal === 'SELL') {
                        stopLoss = closePrice + (atr * 1.5);
                        takeProfit = closePrice - (atr * 2.5);
                    }

                    document.getElementById(loadId).remove();
                    this.renderCard(signal, type, closePrice, (Math.abs(score)*100).toFixed(0), reasons, snapshot, stopLoss, takeProfit, targetTimeStr);

                } catch (e) {
                    console.error(e);
                    document.getElementById(loadId).innerText = "Error.";
                }
            }

            // ============ 4. UI & DATA ============
            renderCard(signal, type, price, conf, reasons, snapshot, sl, tp, timeStr) {
                const id = Date.now();
                const record = { id, time: timeStr, symbol: this.symbol, type, price, status: 'Pending', snapshot };
                this.history.unshift(record);
                localStorage.setItem('twot_history', JSON.stringify(this.history));
                this.renderHistory();

                let buttons = '';
                if(type === 'BUY' || type === 'SELL') {
                    buttons = `
                        <button class="btn-mini btn-win" onclick="app.handleFeedback(${id}, 'Win')">✅ Win</button>
                        <button class="btn-mini btn-loss" onclick="app.handleFeedback(${id}, 'Loss')">❌ Loss</button>
                    `;
                } else {
                    buttons = `
                        <button class="btn-mini btn-missed-buy" onclick="app.handleFeedback(${id}, 'Missed Buy')">↗ Missed Buy</button>
                        <button class="btn-mini btn-missed-sell" onclick="app.handleFeedback(${id}, 'Missed Sell')">↘ Missed Sell</button>
                        <button class="btn-mini btn-good-hold" onclick="app.handleFeedback(${id}, 'Good Hold')">✔ Correct Hold</button>
                    `;
                }

                const html = `
                    <div id="card-${id}" class="prediction-card ${type}">
                        <div class="pred-header">
                            <span class="pred-type">${signal}</span>
                            <span style="font-size:0.9rem; font-weight:bold; background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px;">${timeStr}</span>
                        </div>
                        
                        ${(type === 'BUY' || type === 'SELL') ? `
                        <div class="risk-grid">
                            <div>Ref<br><strong>$${price.toFixed(2)}</strong></div>
                            <div>SL<br><strong style="color:var(--danger)">$${sl.toFixed(2)}</strong></div>
                            <div>TP<br><strong style="color:var(--success)">$${tp.toFixed(2)}</strong></div>
                        </div>
                        ` : `
                        <div style="font-size:0.9rem; margin-bottom:10px;">
                            Ref Price: <strong>$${price}</strong> | Score: <strong>${conf}</strong>
                        </div>
                        `}

                        <ul style="font-size:0.8rem; color:var(--muted); margin-left:15px; margin-bottom:10px;">
                            ${reasons.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                        <div class="feedback-area">${buttons}</div>
                    </div>
                `;
                document.getElementById('predictionFeed').insertAdjacentHTML('afterbegin', html);
            }

            handleFeedback(id, result) {
                const card = document.getElementById(`card-${id}`);
                if(card) {
                    card.querySelectorAll('button').forEach(b => b.remove());
                    const badge = document.createElement('div');
                    badge.innerText = result.toUpperCase();
                    badge.style.textAlign='center'; badge.style.fontWeight='bold';
                    badge.style.color = result.includes('Win') || result.includes('Good') ? 'var(--success)' : result.includes('Missed') ? 'var(--primary)' : 'var(--danger)';
                    card.appendChild(badge);
                }

                const idx = this.history.findIndex(h => h.id === id);
                if(idx === -1) return;
                this.history[idx].status = result;
                
                if(result === 'Win') this.stats.wins++; 
                else if(result === 'Loss') this.stats.losses++;

                const snap = this.history[idx].snapshot;

                if(result === 'Loss') {
                    const exists = this.blacklist.some(b => b.btcTrend === snap.btcTrend && b.rsiState === snap.rsiState);
                    if(!exists) this.blacklist.push({ ...snap, count: 1 });
                } else if (result.includes('Missed')) {
                    const initLen = this.blacklist.length;
                    this.blacklist = this.blacklist.filter(b => !(b.btcTrend === snap.btcTrend && b.rsiState === snap.rsiState));
                    if(this.blacklist.length < initLen) alert("AI Adjusted: Penalty Removed.");
                }

                localStorage.setItem('twot_blacklist', JSON.stringify(this.blacklist));
                localStorage.setItem('twot_history', JSON.stringify(this.history));
                localStorage.setItem('twot_stats', JSON.stringify(this.stats));
                this.renderStats();
                this.renderBlacklist();
                this.renderHistory();
            }

            renderBlacklist() {
                const div = document.getElementById('blacklistContainer');
                if(this.blacklist.length === 0) { div.innerHTML='<div style="text-align:center;color:var(--muted)">No penalties active.</div>'; return; }
                div.innerHTML = this.blacklist.map(b => `
                    <div style="background:rgba(239,68,68,0.1); padding:8px; border-radius:4px; margin-bottom:5px; font-size:0.8rem; border-left:3px solid var(--danger)">
                        Penalty: BTC ${b.btcTrend} + RSI ${b.rsiState}
                    </div>`).join('');
            }

            renderHistory() {
                document.getElementById('historyList').innerHTML = this.history.slice(0,10).map(h => `
                    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:4px; font-size:0.85rem; display:flex; justify-content:space-between;">
                        <span>${h.time} - ${h.symbol}</span>
                        <strong style="color:${h.type==='BUY'?'var(--success)':h.type==='SELL'?'var(--danger)':'var(--muted)'}">${h.type}</strong>
                        <span>${h.status}</span>
                    </div>
                `).join('');
            }

            renderStats() {
                const total = this.stats.wins + this.stats.losses;
                const acc = total === 0 ? 0 : Math.round((this.stats.wins/total)*100);
                document.getElementById('totalWins').innerText = this.stats.wins;
                document.getElementById('totalLosses').innerText = this.stats.losses;
                document.getElementById('accuracy').innerText = acc + '%';
            }

            clearHistory() { if(confirm('Clear all data?')) { localStorage.clear(); location.reload(); } }

            // HELPERS
            formatKlines(d) { return d.map(k => ({time:k[0], open:parseFloat(k[1]), high:parseFloat(k[2]), low:parseFloat(k[3]), close:parseFloat(k[4]), volume:parseFloat(k[5])})); }
            calculateSMA(d, p) { if(d.length<p)return d[0].close; return d.slice(-p).reduce((a,b)=>a+b.close,0)/p; }
            calculateRSI(d) { let g=0,l=0; for(let i=d.length-14;i<d.length;i++){const x=d[i].close-d[i-1].close; x>0?g+=x:l-=x;} return 100-(100/(1+(g/14)/(l/14||1))); }
            calculateATR(d) { let t=0; for(let i=1;i<d.length;i++) t+=Math.abs(d[i].close-d[i-1].close); return t/d.length; }
            
            // RESTORED INDICATORS
            calculateBollinger(d) { 
                const sl=d.slice(-20); const sma=sl.reduce((a,b)=>a+b.close,0)/20; 
                const sd=Math.sqrt(sl.reduce((a,b)=>a+Math.pow(b.close-sma,2),0)/20); 
                return { upper:sma+(2*sd), lower:sma-(2*sd) }; 
            }
            detectSweep(klines) {
                const recent = klines.slice(-5);
                const current = recent[recent.length-1];
                const prev = recent[recent.length-2];
                if (current.low < prev.low && current.close > prev.low) return 'Bullish Sweep';
                if (current.high > prev.high && current.close < prev.high) return 'Bearish Sweep';
                return null;
            }

            setupUI() {
                document.getElementById('startBtn').onclick = () => this.toggleSession();
                document.getElementById('stopBtn').onclick = () => this.toggleSession();
                document.getElementById('symbolSelect').onchange = (e) => { this.symbol=e.target.value; this.updateMonitor(); };
                document.getElementById('timeframeSelect').onchange = (e) => { this.timeframe=e.target.value; this.updateCountdown(); };
                document.querySelectorAll('.tab').forEach(t => t.onclick = () => {
                    document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                    t.classList.add('active'); document.getElementById(t.dataset.tab + 'Tab').classList.add('active');
                });
            }
        }
        const app = new TwoTRestored();
    </script>
</body>
</html>

